pid /var/run/nginx.pid;

worker_processes auto;
worker_rlimit_nofile 100000;

events {
	worker_connections 9000;
	multi_accept on;
}

http {
	##################################################################
	# Core HTTP behaviour                                             #
	##################################################################
	sendfile on;
	tcp_nopush on;
	tcp_nodelay on;
	server_tokens off;
	server_name_in_redirect off;

	include /etc/nginx/mime.types;
	default_type application/octet-stream;

	access_log /var/log/nginx/access.log;
	error_log /var/log/nginx/error.log;

	reset_timedout_connection on;
	client_body_timeout 10s;
	client_header_timeout 10s;
	keepalive_timeout 69s;
	send_timeout 69s;
	proxy_read_timeout 120s;
	keepalive_requests 1337;

	gzip on;
	gzip_vary on;
	gzip_comp_level 6;
	gzip_min_length 1000;
	gzip_proxied expired no-cache no-store private auth;
	gzip_types application/javascript application/json application/ld+json application/manifest+json application/x-font-ttf application/x-web-app-manifest+json application/xhtml+xml application/xml font/opentype image/bmp image/svg+xml image/x-icon text/cache-manifest text/css text/plain text/vcard;

	client_max_body_size 10m;

	##################################################################
	# Shared caches / limits                                          #
	##################################################################
	proxy_cache_path /var/cache/nginx/services keys_zone=services:200m levels=1:2 inactive=30d max_size=200m;
	proxy_cache_path /var/cache/nginx/apihot keys_zone=apihot:200m levels=1:2 inactive=60m max_size=20m;
	proxy_cache_path /var/cache/nginx/apiwarm keys_zone=apiwarm:200m levels=1:2 inactive=24h max_size=200m;
	proxy_cache_path /var/cache/nginx/apinormal keys_zone=apinormal:200m levels=1:2 inactive=30d max_size=2000m;
	proxy_cache_path /var/cache/nginx/apicold keys_zone=apicold:200m levels=1:2 inactive=60d max_size=2000m;
	types_hash_max_size 8192;

	geo $remote_addr $mempool_external {
		127.0.0.1 '';
		::1 '';
		default 1;
	}

	geo $limited_ip {
		default 1;
		127.0.0.1 0;
		::1 0;
	}
	map $limited_ip $limited_ip_key {
		1 $binary_remote_addr;
		0 '';
	}

	limit_req_zone $limited_ip_key zone=api:5m rate=200r/m;
	limit_conn_zone $limited_ip_key zone=websocket:10m;

	##################################################################
	# Language helpers                                                #
	##################################################################
	map $http_accept_language $header_lang {
		default en-US;
		~*^en-US en-US;
		~*^en en-US;
		~*^ar ar;
		~*^cs cs;
		~*^da da;
		~*^de de;
		~*^es es;
		~*^fa fa;
		~*^fr fr;
		~*^ko ko;
		~*^hi hi;
		~*^it it;
		~*^he he;
		~*^ka ka;
		~*^hu hu;
		~*^mk mk;
		~*^nl nl;
		~*^ja ja;
		~*^nb nb;
		~*^pl pl;
		~*^pt pt;
		~*^ro ro;
		~*^ru ru;
		~*^sl sl;
		~*^fi fi;
		~*^sv sv;
		~*^th th;
		~*^tr tr;
		~*^uk uk;
		~*^vi vi;
		~*^zh zh;
		~*^ne ne;
		~*^lt lt;
		~*^hr hr;
	}
	map $cookie_lang $lang {
		default $header_lang;
		~*^en-US en-US;
		~*^en en-US;
		~*^ar ar;
		~*^cs cs;
		~*^da da;
		~*^de de;
		~*^es es;
		~*^fa fa;
		~*^fr fr;
		~*^ko ko;
		~*^hi hi;
		~*^it it;
		~*^he he;
		~*^ka ka;
		~*^hu hu;
		~*^mk mk;
		~*^nl nl;
		~*^ja ja;
		~*^nb nb;
		~*^pl pl;
		~*^pt pt;
		~*^ro ro;
		~*^ru ru;
		~*^sl sl;
		~*^fi fi;
		~*^sv sv;
		~*^th th;
		~*^tr tr;
		~*^uk uk;
		~*^vi vi;
		~*^zh zh;
		~*^ne ne;
		~*^lt lt;
		~*^hr hr;
	}

	##################################################################
	# Upstreams                                                       #
	#  - mempool_backend : Express backend (REST + WS)        #
	#  - esplora          : Esplora-compatible REST API       #
	##################################################################
	upstream mempool_backend {
		server explorer-api:8999;
		keepalive 32;
	}
	upstream esplora {
		server electrum:3000;
		keepalive 32;
	}

	##################################################################
	# Frontend server                                                 #
	##################################################################
	server {
		listen 0.0.0.0:8080;
		server_name _;

		# Static assets built under dist/mempool/browser
		root /var/www/mempool/browser;
		index index.html;

		add_header Cache-Control "public, no-transform";
		add_header Pragma "public";
		add_header Vary Accept-Language;
		add_header Vary Cookie;

		##############################################################
		# Static / SPA routing                                       #
		##############################################################
		location = / {
			if ($lang != '') {
				return 302 $scheme://$host/$lang/;
			}
			try_files /en-US/index.html =404;
			expires 5m;
		}
		location ~ ^/([a-z][a-z])/(.+\..+\.(js|css))$ {
			try_files $uri =404;
			expires 1y;
		}
		location ~ ^/([a-z][a-z])$ {
			try_files $uri /$1/index.html /en-US/index.html =404;
			expires 5m;
		}
		location ~ ^/([a-z][a-z])/ {
			try_files $uri /$1/index.html /en-US/index.html =404;
			expires 5m;
		}
		location /resources {
			try_files $uri /en-US/index.html;
			expires 1w;
		}
		location /resources/config. {
			try_files $uri =404;
			expires 5m;
		}
		location /resources/customize. {
			try_files $uri =404;
			expires 5m;
		}
		location ~* ^/.+\..+\.(js|css)$ {
			try_files /$lang/$uri /en-US/$uri =404;
			expires 1y;
		}
		location /preview {
			try_files /$lang/$uri $uri /en-US/$uri /en-US/index.html =404;
			expires 10m;
		}
		location / {
			try_files /$lang/$uri /$lang/$uri/ $uri $uri/ /en-US/$uri @index-redirect;
			expires 10m;
		}
		location @index-redirect {
			rewrite (.*) /$lang/index.html;
		}

		##############################################################
		# Backend REST (mempool)                                     #
		##############################################################
		location /api/v1/internal/ {
			if ($mempool_external) {
				return 403;
			}
			limit_req zone=api burst=40 nodelay;
			proxy_pass http://mempool_backend;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
			proxy_redirect off;
		}

		location /api/v1/ws {
			limit_conn websocket 200;
			proxy_pass http://mempool_backend;
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection "upgrade";
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
		}

		location /ws {
			limit_conn websocket 200;
			proxy_pass http://mempool_backend;
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection "upgrade";
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
		}

		location /api/v1/statistics {
			try_files /dev/null @mempool-api-v1-cache-warm;
		}
		location /api/v1/mining {
			try_files /dev/null @mempool-api-v1-cache-warm;
		}
		location /api/v1/fees/recommended {
			try_files /dev/null @mempool-api-v1-cache-hot;
		}
		location /api/v1/accelerations {
			try_files /dev/null @mempool-api-v1-cache-hot;
		}
		location /api/v1/block/ {
			try_files /dev/null @mempool-api-v1-cache-forever;
		}
		location /api/v1 {
			try_files /dev/null @mempool-api-v1-cache-normal;
		}

		##############################################################
		# Esplora REST pass-through                                  #
		##############################################################
		location /api/internal/ {
			return 403;
		}
		location /api/block/ {
			rewrite ^/api/(.*)$ /$1 break;
			try_files /dev/null @esplora-api-cache-forever;
		}
		location /api/ {
			rewrite ^/api/(.*)$ /$1 break;
			try_files /dev/null @esplora-api-cache-minimal;
		}

		##############################################################
		# Static API docs dedicated routes                           #
		##############################################################
		location = /api {
			try_files $uri $uri/ /en-US/index.html =404;
		}
		location = /api/ {
			try_files $uri $uri/ /en-US/index.html =404;
		}

		##############################################################
		# Named locations - backend                                  #
		##############################################################
		location @mempool-api-v1-cache-forever {
			limit_req zone=api burst=40 nodelay;
			proxy_pass http://mempool_backend;

			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;

			proxy_cache_background_update on;
			proxy_cache_use_stale updating;
			proxy_cache apicold;
			proxy_cache_valid 200 30d;
			proxy_redirect off;

			expires 30d;
		}

		location @mempool-api-v1-cache-hot {
			limit_req zone=api burst=40 nodelay;
			proxy_pass http://mempool_backend;

			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;

			proxy_cache_background_update on;
			proxy_cache_use_stale updating;
			proxy_cache apihot;
			proxy_cache_valid 200 1s;
			proxy_redirect off;

			expires 1s;
		}

		location @mempool-api-v1-cache-warm {
			limit_req zone=api burst=40 nodelay;
			proxy_pass http://mempool_backend;

			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;

			proxy_cache_background_update on;
			proxy_cache_use_stale updating;
			proxy_cache apiwarm;
			proxy_cache_valid 200 10s;
			proxy_redirect off;

			expires 120s;
		}

		location @mempool-api-v1-cache-normal {
			limit_req zone=api burst=40 nodelay;
			proxy_pass http://mempool_backend;

			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;

			proxy_cache apinormal;
			proxy_cache_valid 200 2s;
			proxy_redirect off;

			expires 2s;
		}

		##############################################################
		# Named locations - esplora                                  #
		##############################################################
		location @esplora-api-cache-forever {
			limit_req zone=api burst=200 nodelay;
			proxy_pass http://esplora;

			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
			proxy_pass_header Access-Control-Allow-Origin;

			proxy_cache_background_update on;
			proxy_cache_use_stale updating;
			proxy_cache apicold;
			proxy_cache_valid 200 30d;
			proxy_redirect off;

			expires 30d;
		}

		location @esplora-api-cache-minimal {
			limit_req zone=api burst=200 nodelay;
			proxy_pass http://esplora;

			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
			proxy_pass_header Access-Control-Allow-Origin;

			proxy_cache_background_update on;
			proxy_cache_use_stale updating;
			proxy_cache apihot;
			proxy_cache_valid 200 1s;
			proxy_redirect off;

			expires 1s;
		}
	}
}
